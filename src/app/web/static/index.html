<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimodal Classifier - Real-time AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            max-width: 1200px;
            margin: 0 auto 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 1.3em;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #webcamVideo, #previewImage, #previewVideo {
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none;
        }

        .result-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-main {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .confidence {
            font-size: 1.3em;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .top3 {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .top3-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .top3-item:last-child {
            border-bottom: none;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s;
        }

        .model-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .model-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .model-btn:hover {
            background: #f0f2ff;
            transform: translateY(-1px);
        }

        .model-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .status {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fps {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .video-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ¤– Multimodal AI Classifier</h1>
            <p class="subtitle">Real-time image and video classification with Deep Learning</p>
        </header>

        <div class="status" id="status">
            <span class="loading"></span> Connecting to server...
        </div>

        <div class="model-selector">
            <button class="model-btn active" onclick="switchModel('resnet', this)">ResNet50</button>
            <button class="model-btn" onclick="switchModel('mobilenet', this)">MobileNetV2</button>
        </div>

        <div class="main-content">
            <!-- Upload Image -->
            <div class="card">
                <h2><span class="icon"></span> Classify Image</h2>
                <div class="upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
                    <p style="font-size: 3em; margin-bottom: 10px;"></p>
                    <p style="color: #667eea; font-weight: bold;">Click or drag an image</p>
                    <p style="color: #999; font-size: 0.9em; margin-top: 5px;">JPG, PNG, JPEG</p>
                </div>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageLoad(event)">
                <img id="previewImage" class="hidden">
                <div class="image-actions hidden" id="imageActions" style="margin-top: 15px; text-align: center;">
                    <button class="btn" onclick="classifyImage()">Classify Image</button>
                </div>
                <div id="imageResult" class="hidden"></div>
            </div>

            <!-- Real-time Webcam -->
            <div class="card">
                <h2><span class="icon"></span> Real-time Webcam</h2>
                <div class="video-container">
                    <video id="webcamVideo" class="hidden" autoplay playsinline></video>
                    <canvas id="webcamCanvas" class="hidden"></canvas>
                    <canvas id="capturedCanvas" class="hidden"></canvas>
                    <div id="fps" class="fps hidden">FPS: 0</div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button class="btn" id="webcamBtn" onclick="toggleWebcam()">Start Webcam</button>
                    <button class="btn hidden" id="captureBtn" onclick="capturePhoto()"> Capture Photo</button>
                    <button class="btn hidden" id="classifyCaptureBtn" onclick="classifyCapturedPhoto()"> Classify Capture</button>
                </div>
                <img id="capturedImage" class="hidden">
                <div id="webcamResult" class="hidden"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let webcamStream = null;
        let webcamSocket = null;
        let isWebcamActive = false;
        let lastFrameTime = Date.now();
        let frameCount = 0;

        // Verify server status
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                const data = await response.json();
                document.getElementById('status').innerHTML = `
                     Server connected | Model: <strong>${data.model_type}</strong> | Classes: ${data.classes.length}
                `;
            } catch (error) {
                document.getElementById('status').innerHTML = ' Connection error with server';
            }
        }

        // Switch model
        async function switchModel(modelType, buttonElement) {
            try {
                // Show loading
                buttonElement.innerHTML = '<span class="loading"></span>';
                buttonElement.disabled = true;
                
                const response = await fetch(`${API_URL}/api/model/switch?model_type=${modelType}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    // Update all buttons visually
                    document.querySelectorAll('.model-btn').forEach(btn => {
                        btn.classList.remove('active');
                        btn.disabled = false;
                    });
                    buttonElement.classList.add('active');
                    
                    // Restore button text
                    if (modelType === 'resnet') {
                        buttonElement.innerHTML = 'ResNet50';
                    } else {
                        buttonElement.innerHTML = 'MobileNetV2';
                    }
                    
                    // Update status
                    await checkServerStatus();
                    
                    // Show notification
                    const status = document.getElementById('status');
                    status.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    status.style.color = 'white';
                    status.innerHTML = ` Model changed to <strong>${modelType === 'resnet' ? 'ResNet50' : 'MobileNetV2'}</strong>`;
                    
                    // Return to normal style after 3 seconds
                    setTimeout(() => {
                        status.style.background = 'rgba(255,255,255,0.9)';
                        status.style.color = 'inherit';
                        checkServerStatus();
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Error changing model');
                }
            } catch (error) {
                console.error('Error changing model:', error);
                alert('Error changing model: ' + error.message);
                
                // Restore button in case of error
                if (modelType === 'resnet') {
                    buttonElement.innerHTML = 'ResNet50';
                } else {
                    buttonElement.innerHTML = 'MobileNetV2';
                }
                buttonElement.disabled = false;
            }
        }

        // Global variables for loaded image
        let currentImageFile = null;
        let capturedPhotoBlob = null;

        // Load image (without classifying automatically)
        function handleImageLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentImageFile = file;

            // Preview
            const preview = document.getElementById('previewImage');
            preview.src = URL.createObjectURL(file);
            preview.classList.remove('hidden');

            // Show classify button
            document.getElementById('imageActions').classList.remove('hidden');
            document.getElementById('imageResult').classList.add('hidden');
        }

        // Classify loaded image
        async function classifyImage() {
            if (!currentImageFile) {
                alert('Please load an image first');
                return;
            }

            // Show loading
            document.getElementById('imageResult').innerHTML = '<div class="loading"></div> Classifying...';
            document.getElementById('imageResult').classList.remove('hidden');

            // Upload and predict
            const formData = new FormData();
            formData.append('file', currentImageFile);

            try {
                const response = await fetch(`${API_URL}/api/predict/image`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    showResult('imageResult', data);
                } else {
                    throw new Error(data.error || 'Error classifying');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('imageResult').innerHTML = `
                    <div style="background: #ff4444; color: white; padding: 15px; border-radius: 10px;">
                         Error: ${error.message}
                    </div>
                `;
            }
        }

        // Capture photo from webcam
        function capturePhoto() {
            const video = document.getElementById('webcamVideo');
            const canvas = document.getElementById('capturedCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            // Convert to image
            canvas.toBlob((blob) => {
                capturedPhotoBlob = blob;
                
                // Show preview
                const capturedImg = document.getElementById('capturedImage');
                capturedImg.src = URL.createObjectURL(blob);
                capturedImg.classList.remove('hidden');

                // Show classify button
                document.getElementById('classifyCaptureBtn').classList.remove('hidden');
                document.getElementById('webcamResult').classList.add('hidden');
            }, 'image/jpeg', 0.95);
        }

        // Classify captured photo
        async function classifyCapturedPhoto() {
            if (!capturedPhotoBlob) {
                alert('Please capture a photo first');
                return;
            }

            // Show loading
            document.getElementById('webcamResult').innerHTML = '<div class="loading"></div> Classifying...';
            document.getElementById('webcamResult').classList.remove('hidden');

            // Upload and predict
            const formData = new FormData();
            formData.append('file', capturedPhotoBlob, 'captured.jpg');

            try {
                const response = await fetch(`${API_URL}/api/predict/image`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    showResult('webcamResult', data);
                } else {
                    throw new Error(data.error || 'Error classifying');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('webcamResult').innerHTML = `
                    <div style="background: #ff4444; color: white; padding: 15px; border-radius: 10px;">
                         Error: ${error.message}
                    </div>
                `;
            }
        }

        // Start/stop webcam
        async function toggleWebcam() {
            if (isWebcamActive) {
                stopWebcam();
            } else {
                await startWebcam();
            }
        }

        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('webcamVideo');
                video.srcObject = webcamStream;
                video.classList.remove('hidden');
                document.getElementById('webcamBtn').textContent = 'Stop Webcam';
                document.getElementById('captureBtn').classList.remove('hidden');
                isWebcamActive = true;

                // Clear previous capture
                document.getElementById('capturedImage').classList.add('hidden');
                document.getElementById('classifyCaptureBtn').classList.add('hidden');
                document.getElementById('webcamResult').classList.add('hidden');
                capturedPhotoBlob = null;

            } catch (error) {
                console.error('Error accessing webcam:', error);
                alert('Could not access webcam');
            }
        }

        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }
            if (webcamSocket) {
                webcamSocket.close();
            }
            document.getElementById('webcamVideo').classList.add('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('webcamBtn').textContent = 'Start Webcam';
            isWebcamActive = false;
        }

        // Show results
        function showResult(elementId, data) {
            const element = document.getElementById(elementId);
            
            let top3HTML = '';
            if (data.top3_predictions) {
                top3HTML = '<div class="top3"><strong>Top 3 Predictions:</strong>';
                data.top3_predictions.forEach(pred => {
                    top3HTML += `
                        <div class="top3-item">
                            <span>${pred.class}</span>
                            <span>${pred.confidence.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pred.confidence}%"></div>
                        </div>
                    `;
                });
                top3HTML += '</div>';
            }

            element.innerHTML = `
                <div class="result-box">
                    <div class="result-main"> ${data.predicted_class}</div>
                    <div class="confidence">Confidence: ${data.confidence.toFixed(1)}%</div>
                    ${top3HTML}
                </div>
            `;
            element.classList.remove('hidden');
        }

        // Drag and drop for images
        const imageUploadArea = document.getElementById('imageUploadArea');
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('dragover');
        });
        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('dragover');
        });
        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                document.getElementById('imageInput').files = e.dataTransfer.files;
                handleImageLoad({ target: { files: [file] } });
            }
        });

        // Initialize
        checkServerStatus();
        setInterval(checkServerStatus, 10000); // Update every 10s
    </script>
</body>
</html>
